<template>
  <div>
    <TrainingBtnControls
      @setDuration="setDuration"
      @start="start"
      @onSaveTraining="confirmAddTrainingDescription"
      :readOnly="readOnly"
    ></TrainingBtnControls>
    <q-skeleton height="150px" square v-show="showSkeleton" />
    <BaseNested
      v-show="!showSkeleton"
      :readOnly="readOnly"
      :data="item.exerciseGroup"
      @onAddExercise="onAddExercise"
      @onDeleteGroup="onDeleteGroup"
      @onDeleteExercise="onDeleteExercise"
      @onUpdateExercise="onUpdateExercise"
      @onUpdateGroup="onUpdateGroup"
      @onUpdateExerciseField="onUpdateExerciseField"
      @onAddCustomExercise="onAddCustomExercise"
    ></BaseNested>

    <BaseInitCounter ref="initCounter"></BaseInitCounter>
    <ClientOnly>
      <TrainingCounter ref="trainingCounter"></TrainingCounter>
    </ClientOnly>
    <BaseFab @newItem="addGroup" v-if="!props.readOnly"></BaseFab>
    <BaseDialogYesNo
      ref="dialog"
      @ok="addDescription"
      @cancel="onSaveTraining"
      propHeader="Добавить описание?"
      propOkText="Да"
      propOkColor="green"
      propCancelText="Нет"
      :propBody="description"
    ></BaseDialogYesNo>
  </div>
</template>

<script lang="ts" setup>
const props = defineProps({
  readOnly: {
    type: Boolean,
    default: false,
  },
});
const dialog = ref(null);
const store = trainingStore();
const item = computed(() => store.getCurrentItem);
const showSkeleton = ref(true);
watch(
  () => item,
  (val) => {
    showSkeleton.value = false;
  },
  { deep: true }
);

const storeExerciseGroup = exerciseGroupStore();
const storeExercise = exerciseStore();
const description = ref("");

const confirmAddTrainingDescription = () => {
  description.value = exerciseToText(store.currentItem.exerciseGroup);
  dialog.value.show();
};

const onDeleteExercise = async (id: Number) => {
  await storeExercise.deleteItem(id);
  removeNestedItemFromArr(id, store.currentItem.exerciseGroup);
};

const onAddExercise = async (item: ExerciseGroup) => {
  if (store.currentItem.exerciseGroup.length > 0) {
    await storeExercise.newExercise(item.id);
    item.exercise.push(storeExercise.currentItem);
  }
};

const onAddCustomExercise = async (id, val) => {
  let exercise = findExerciseById(store.currentItem.exerciseGroup, id);
  await storeExercise.updateCustomExercise(exercise, val);
  updateNestedItem(storeExercise.currentItem, store.currentItem.exerciseGroup);
};

const onUpdateExercise = async (id, exerciseTemplate) => {
  let exercise = findExerciseById(store.currentItem.exerciseGroup, id);
  await storeExercise.cloneTemplateItem(exerciseTemplate, exercise);
  updateNestedItem(storeExercise.currentItem, store.currentItem.exerciseGroup);
};

const addDescription = async () => {
  store.currentItem.description = description.value;
  await onSaveTraining();
};

const onSaveTraining = async () => {
  await store.updateTrainingPlan();
};
const addGroup = async () => {
  storeExerciseGroup.resetCurrentItem(
    store.currentItem.id,
    store.currentItem.exerciseGroup.length
  );
  const group = await storeExerciseGroup.create();

  updateArray(group, store.currentItem.exerciseGroup);
};

const onUpdateGroup = async (field, value, id) => {
  await storeExerciseGroup.updateItemField(
    field,
    value,
    id,
    store.currentItem.exerciseGroup
  );
};

const onUpdateExerciseField = async (field, val, id) => {
  let exercise = findExerciseById(store.currentItem.exerciseGroup, id);
  await storeExercise.updateItemField(field, val, id, exercise);
};

const onDeleteGroup = async (id: Number) => {
  await storeExerciseGroup.deleteItem(id);
  removeItemFromArr(id, store.currentItem.exerciseGroup);
};
const setDuration = async (val) => {
  await store.setDuration(val);
};
const initCounter = ref(null);
const start = async (val) => {
  await initCounter.value.start();
  store.isStarted = true;
};

const trainingcounter = ref(null);
const restart = () => {
  trainingcounter.value.resetTraining();
};
//todo add mute button to counter
const stopTimer = () => {
  workout.value.resetTraining();
};
const duration = ref({ min: 0, sec: 0 });
</script>

<style></style>
